#!/usr/bin/env ruby
# - encoding: utf-8 -
#
# Intro (in German):
# https://depone.net/2016/03/01/video-in-animiertes-gif-konvertieren/

require 'tmpdir'

DEFAULT_WIDTH=400
DEFAULT_FPS=10
name = ARGV[0]

if ARGV.length == 0 or name == '--help'
  puts <<EOL
usage: convert-to-gif <filename> [<width>] [<fps>]

Supply a video file that should be converted as <filename> and resize
the resulting GIF to <width> with <fps> frames per second. Width and
frames per second are optional parameters.

$ convert-to-gif video.mp4

Will result in a GIF with #{DEFAULT_FPS} fps that is #{DEFAULT_WIDTH}
pixel wide.
EOL
  exit
end

folder = Dir.mktmpdir
unless File.exist?(name)
  abort "File [#{name}] does not exist. Please see --help."
end

width = ARGV[1] || DEFAULT_WIDTH
fps = ARGV[2] || DEFAULT_FPS

basename = File.basename(name, ".*")
system("ffmpeg -i #{name} -vf scale=#{width}:-1:flags=lanczos,fps=#{fps} #{folder}/frame-%03d.png")
system("convert -loop 0 #{folder}/frame-*png #{basename}.gif")
